require './lib/lt_base.rb'
require './lib/util/redis_server.rb'
require 'irb'
StandaloneMigrations::Tasks.load_tasks

desc 'Default does nothing at the moment - just used to check if rake compiles'
task :default do
  puts "Default task does nothing at this time."
end

task :full_tests do
  Rake::Task[:'lt:test:run_full_tests'].invoke
end

task :tests do
  Rake::Task[:'lt:test:run_tests'].invoke
end

task :console do
  Rake::Task[:'lt:console'].invoke
end


namespace :lt do
  namespace :webapp do
    desc "Run WebApp tests"
    task :run_tests do
      ENV['RAILS_ENV'] = 'test'
      LT::setup_environment(File::dirname(__FILE__))
      LT::boot_db(File::expand_path('./db/config.yml'))
      LT::run_test('webapp_test.rb', File::expand_path('./test'))
    end
    desc "Boot WebApp environment"
    task :boot do
      Rake::Task[:'lt:boot'].invoke
    end
    desc "Run WebApp server - this starts the webserver"
    task :start_webapp do 
      path = File::expand_path(File::dirname(__FILE__))
      rackup_file = File::join(path, 'lib', 'webapp.ru')
      # TODO - set port/server from environment var
      run_cmd = "rackup -p 8080 -o localhost #{rackup_file}"
      $stdout.sync = true
      Kernel.system(run_cmd)
    end
    desc "Run WebApp server - this starts the webserver in dev mode with rerun"
    task :start_webapp_dev do 
      path = File::expand_path(File::dirname(__FILE__))
      rackup_file = File::join(path, 'lib', 'webapp.ru')
      # TODO - set port/server from environment var
      run_cmd = "rerun -- rackup -p 8080 -o localhost #{rackup_file}"
      $stdout.sync = true
      Kernel.system(run_cmd)
    end
  end

  desc "Boot up a console with required context"
  task :console => [:boot] do
    IRB.setup nil
    IRB.conf[:MAIN_CONTEXT] = IRB::Irb.new.context
    require 'irb/ext/multi-irb'
    IRB.irb nil, self
  end

  desc "Boot Core-app system"
  task :boot do
    LT::boot_all(File::dirname(__FILE__))
    LT::logger.info("Core-app booted")
  end

  desc "Seed environment db with data (generally speaking, don't do this in testing env)"
  task :seed => [:'lt:boot', :'db:seed']

  namespace :test do
    desc "Run complete test suite include DB teardown/rebuild/reseed"
    task :run_full_tests => [:'lt:test:boot', :'db:full_reset'] do
      LT::logger.info("Test setup complete. Running all tests.")
      LT::run_tests
    end
    
    desc "Run complete test suite w/out DB reset"
    task :run_tests => [:'lt:test:boot', 
      :'lt:test:db:migrate_tables'] do
      LT::run_tests
    end

    desc "Run single test file"
    task :run_test, [:testfile] => [:'lt:test:boot', 
      :'lt:test:db:migrate_tables'] do |t, args|
      filename = args[:testfile]
      LT::run_test(filename, LT::test_path)
    end

    # TODO:  Get this to work (covered by all tests however)
    #desc "Run Redis Raw Message Test"
    #task :redis_raw_messages do
    #  #LT::run_test("redisserver_test.rb", LT::test_path)
    #  #Rake::Task[:'lt:test:run_test[./test/redisserver_test.rb]'].invoke
    #end

    task :boot do
      # Force us into testing environment, then boot core-app
      ENV['RAILS_ENV'] = 'test'
      Rake::Task[:'lt:boot'].invoke
      LT::testing!
    end
    namespace :db do
      desc "Drop and recreate test db, run migrations"
      task :full_reset => [:'lt:boot', :drop_db, :create_db, :migrate_tables] do
        LT::logger.info("Performing full DB testing reset")
      end
      desc "Drop test db"
      task :drop_db do
        ## BUG: If DB can't be dropped, this command does not raise an exception
        ##      It only prints a screen warning which is easy to miss
        ## Rec: Raise exception if DB exists after dropping?
        LT::testing!
        LT::logger.info("Dropping testing DB")
        Rake::Task[:'db:drop'].invoke
      end
      task :create_db do
        LT::testing!
        LT::logger.info("Creating testing DB")
        Rake::Task[:'db:create'].invoke
      end
      task :migrate_tables do
        LT::testing!
        LT::logger.info("Migrating testing DB")
        Rake::Task[:'db:migrate'].invoke
      end
    end
  end # test namesapce
end # lt namespace


