/*
 * loader.js
 *
 * Copyright 2014 Learning Tapestry, Inc.
 * All rights reserved
 *
*/

// This file is designed to be as small as possible so that it can be loaded
// synchronously by the calling page with a simple script tag
// This file will load additional javascript library files as needed asynchronously

// calling parameters: it is expected that this library will be called with URL parameters
//   username: identifier to the user
//   org_api_key: identifier provided by Learning Tapestry
//   load: the library this autoloader should load (usually "collector")
//   autostart: "true" will autoboot this library
//     If autostart is not true, you can manually boot loader by calling
//       window.lt.init(function(){//code to run when init is finished});
//     Generally you would skip autostart if you need a callback when init is loaded

// javascript sdk
(function(window, undefined) {
  if (window.lt) {
    return;
  }
  var lt = {};
  var loadScript = function (url, callback) {
    var script = document.createElement('script');
    script.async = true;
    script.src = url;
    var entry = document.getElementsByTagName('script')[0];
    entry.parentNode.insertBefore(script, entry);
    script.onload = script.onreadystatechange = function() {
      var rdyState = script.readyState;
      if (!rdyState || /complete|loaded/.test(script.readyState)) {
        callback();
        script.onload = null;
        script.onreadystatechange = null;
      }
    };
  };
  lt.loadScript = loadScript;
  //this function is generated by Sinatra and contains all the requested libraries to load
  //this function should be called to initiate the async load/boot process for LT libraries
  lt.init = function(callback) {
    <%lt_api_libs.each do |lt_api_lib|%>
      lt.loadScript('<%=lt_api_server%>/api/v1/<%=lt_api_lib%>.js?username=<%=user_id%>&org_api_key=<%=org_api_key%>', callback);
    <%end%>
  };
  <%
  #include autostart if requested
  if autostart%>
    lt.init(function(){});
  <%end%>
  window.lt = lt;
})(this);


