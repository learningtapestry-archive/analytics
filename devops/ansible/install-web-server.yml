---
  # run: 
  #   ssh-agent bash
  #   ssh-add ./secrets/id_deploy
  #   ansible-playbook -i [lt_env]-hosts.rb --ask-vault-pass --ask-sudo-pass install-web-server.yml 
  # sudo password is for user deploy
  - hosts: web
    remote_user: deploy
    sudo: yes
    vars:
      ansible_ssh_host: "{{inventory_hostname}}.learningtapestry.com"
      ansible_ssh_user: deploy
      ansible_ssh_private_key_file: ./secrets/id_deploy
    tasks: 
    # vault holds ssl_cert_password
    - include_vars: "./secrets/{{lt_env}}_secrets.yml"
    - name: Install Nginx prerequisites
      shell: sudo apt-get update
    - shell: sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 561F9B9CAC40B2F7
    - shell: touch /etc/apt/sources.list.d/passenger.list
    - lineinfile: >
        state=present
        insertafter=EOF
        dest=/etc/apt/sources.list.d/passenger.list
        line="deb https://oss-binaries.phusionpassenger.com/apt/passenger trusty main"
    - shell: "sudo chown root:root /etc/apt/sources.list.d/passenger.list"
    - shell: sudo chmod 600 /etc/apt/sources.list.d/passenger.list
    - shell: sudo apt-get update
    - action: apt pkg={{ item }} state=installed update_cache=true
      with_items:
        - nginx-extras
        - passenger
    - shell: rm -f /etc/nginx/sites-enabled/*
    - copy: src='./roles/web/files/nginx.learningtap.{{lt_env}}.conf' dest='/etc/nginx/sites-enabled/'
    - copy: >
        src=./roles/web/files/nginx.conf
        dest=/etc/nginx/nginx.conf
      # To verify if passenger is working run: passenger-memory-stats

    - include: fragment-install-web-ssl-keys.yml
      when: "lt_env == 'production'"


