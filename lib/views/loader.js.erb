/*
 * loader.js
 *
 * Copyright 2014 Learning Tapestry, Inc.
 * All rights reserved
 *
*/


// To include this application on your web pages, use the following script tag.
// The script tag can be placed at the bottom of your html page to minimize
// impact on page load user experience.
// <script src="https://api.learningtapestry.org/api/v1/loader.js?username=[your user's ID here]&org_api_key=[your org api key here]&load=collector&autostart=true"></script>

// This file will load additional javascript library files as needed asynchronously

// calling parameters: it is expected that this library will be called with URL parameters
//   username: identifier to the user
//   org_api_key: identifier provided by Learning Tapestry
//   load: the library this autoloader should load (usually "collector")
//   autostart: "true" will autoboot this library
//     If autostart is not true, you can manually boot loader by calling
//       window.lt.init(function(){//code to run when init is finished});
//     Generally you would skip autostart if you need a callback when init is loaded
//   tracking_interval (optional): time in seconds to wait between messages sent to track the current page visit.
//     It only applies to the collector script
//     If not specified the default is 60 seconds


// javascript sdk
(function(window, undefined) {
  if (window.lt) {
    return;
  }
  var lt = {};
  lt.loadScript = function (url, callback) {
    var script = document.createElement('script');
    script.async = true;
    script.src = url;
    var entry = document.getElementsByTagName('script')[0];
    entry.parentNode.insertBefore(script, entry);
    script.onload = script.onreadystatechange = function() {
      var rdyState = script.readyState;
      if (!rdyState || /complete|loaded/.test(script.readyState)) {
        callback();
        script.onload = null;
        script.onreadystatechange = null;
      }
    };
  };
  //lt.loadScript = loadScript;
  //this function is generated by Sinatra and contains all the requested libraries to load
  //this function should be called to initiate the async load/boot process for LT libraries
  lt.init = function(callback) {
    <%lt_api_libs.each do |lt_api_lib|%>
      var scriptUrl = '<%=lt_api_server%>/api/v2/<%=lt_api_lib%>.js?username=<%=user_id%>&org_api_key=<%=org_api_key%>';
      <% if lt_api_lib == 'collector' %>
        scriptUrl += '&tracking_interval=<%=tracking_interval%>';
      <% end %>
      lt.loadScript(scriptUrl, callback);
    <%end%>
  };
  <%
  #include autostart if requested
  if autostart%>
    lt.init(function(){});
  <%end%>
  window.lt = lt;
})(this);


